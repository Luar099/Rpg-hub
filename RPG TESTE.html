<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RPG Hub ‚Äî Guerra do V√©u</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121a24; --muted:#8aa0b6; --txt:#e8f0fb; --line:#223042;
      --btn:#2b6cff; --bad:#ff4d4d; --ok:#32d583;
      --gold:#f5c24b; --violet:#8b5cf6; --cyan:#22c1f1; --green:#32d583; --red:#ff4d4d;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{margin:0;background:linear-gradient(180deg,#070a0f,#0b0f14);color:var(--txt)}
    header{
      padding:18px 16px;border-bottom:1px solid var(--line);
      position:sticky;top:0;background:rgba(11,15,20,.86);backdrop-filter: blur(10px);z-index:5
    }
    h1{margin:0;font-size:18px}
    main{max-width:1220px;margin:0 auto;padding:16px;display:grid;gap:16px}
    .grid{display:grid;gap:16px}
    @media (min-width:980px){ .grid{grid-template-columns:1.15fr .85fr} }
    .card{background:rgba(18,26,36,.96);border:1px solid var(--line);border-radius:18px;padding:16px;backdrop-filter: blur(10px)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;color:var(--muted)}
    input,select,button,textarea{
      border-radius:14px;border:1px solid var(--line);background:#0c131c;color:var(--txt);
      padding:10px 12px;outline:none
    }
    input:focus,select:focus,textarea:focus{border-color:#3b82f6}
    button{cursor:pointer;background:var(--btn);border:none;font-weight:900}
    button.secondary{background:#162235;border:1px solid var(--line)}
    button.danger{background:var(--bad)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .muted{color:var(--muted);font-size:13px;line-height:1.35}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 12px;border:1px solid var(--line);border-radius:999px;background:#0c131c;
      font-size:12px;color:var(--muted)
    }
    .divider{height:1px;background:var(--line);margin:12px 0}
    .hidden{display:none!important}
    .mini{font-size:12px}
    .ok{color:var(--ok);font-weight:900}
    .bad{color:var(--bad);font-weight:900}

    /* Tabs */
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tabBtn{
      background:#0c131c;border:1px solid var(--line);
      padding:10px 12px;border-radius:999px;font-weight:900;color:var(--muted)
    }
    .tabBtn.active{background:var(--btn);color:#fff;border-color:transparent}
    .tabPanel{margin-top:12px}

    /* Overlay / Modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.66);padding:18px;overflow:auto;z-index:60}
    .modal{
      max-width:1120px;margin:18px auto;border:1px solid var(--line);
      border-radius:18px;background:rgba(18,26,36,.96);backdrop-filter: blur(10px);
      padding:16px
    }
    .modalHeader{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap}
    .warn{border:1px solid #5b2c2c;background:#1a0f12;padding:12px;border-radius:14px}
    .good{border:1px solid #235b3e;background:#0f1a14;padding:12px;border-radius:14px}

    /* Selection cards */
    .selectGrid{display:grid;gap:10px}
    @media (min-width:900px){ .selectGrid{grid-template-columns:1fr 1fr} }
    .selectCard{
      border:1px solid var(--line);background:#0b121a;padding:12px;border-radius:18px;
      display:flex;gap:12px;align-items:flex-start;justify-content:space-between
    }
    .selectCard .left{min-width:0}
    .selectCard b{display:block;font-size:14px}
    .tag{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:#0c131c;color:var(--muted);font-size:12px}
    .tag.perfect{background:rgba(245,194,75,.12);border-color:rgba(245,194,75,.55);color:#ffe4a6}
    .tag.lore{background:rgba(139,92,246,.10);border-color:rgba(139,92,246,.45);color:#ddccff}
    .selectedGlow{outline:2px solid rgba(43,108,255,.65); box-shadow: 0 0 0 6px rgba(43,108,255,.12);}

    /* Avatar */
    .avatarBox{width:150px;height:150px;border-radius:18px;border:1px dashed var(--line);background:#0c131c;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .avatarBox img{width:100%;height:100%;object-fit:cover}

    /* Meters */
    .meterRow{display:grid;grid-template-columns:1fr 170px 150px;gap:10px;align-items:center}
    @media (max-width:640px){ .meterRow{grid-template-columns:1fr 1fr} .meterRow .ctrl{grid-column:1/-1;justify-content:flex-end} }
    .bar{height:12px;border-radius:999px;background:#0c131c;border:1px solid var(--line);overflow:hidden}
    .bar > div{height:100%;background:var(--btn);width:0%}
    .ctrl{display:flex;gap:8px;align-items:center}
    .ctrl .num{min-width:28px;text-align:center;font-weight:900}

    /* Player bars */
    .kpiGrid{display:grid;gap:10px}
    @media (min-width:720px){ .kpiGrid{grid-template-columns:1fr 1fr} }
    .kpiBox{border:1px solid var(--line);background:#0c131c;border-radius:16px;padding:12px}
    .kpiTitle{display:flex;justify-content:space-between;gap:10px;align-items:center}
    .kpiTitle b{font-size:13px}
    .kpiValue{font-size:18px;font-weight:950}
    .kpiBar{height:12px;border-radius:999px;background:#0b121a;border:1px solid var(--line);overflow:hidden;margin-top:8px}
    .kpiBar > div{height:100%;width:0%}

    /* Wheel */
    .wheelWrap{display:grid;gap:14px;justify-items:center}
    canvas{border:1px solid var(--line);border-radius:18px;background:#0c131c;max-width:100%}
    .pointer{
      width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;
      border-bottom:20px solid var(--btn);filter:drop-shadow(0 3px 6px rgba(0,0,0,.6));
      margin-top:-8px;
    }

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:13px}
    th{color:var(--muted);font-weight:900}
    .right{text-align:right}
  </style>
</head>
<body>
<header class="row" style="justify-content:space-between">
  <div class="row">
    <h1>üé≤ RPG Hub ‚Äî Guerra do V√©u</h1>
    <span class="pill" id="sessionPill">Sess√£o: n√£o logado</span>
  </div>
  <div class="row">
    <button class="secondary" id="btnReset">Resetar dados</button>
    <button class="secondary hidden" id="btnLogout">Sair</button>
  </div>
</header>

<main>
  <!-- LOGIN -->
  <section class="card" id="loginCard">
    <h2 style="margin:0 0 6px 0;font-size:16px">Entrar</h2>
    <p class="muted" style="margin-top:0">
      Teste: Mestre (<b></b>/<b></b>) ‚Ä¢ Player (<b>player1</b>/<b>1234</b>).
    </p>
    <div class="card" style="padding:14px;background:#0c131c">
      <div class="row">
        <div style="flex:1;min-width:220px">
          <label>Usu√°rio</label>
          <input id="loginUser" placeholder="ex: mestre ou player1" autocomplete="username"/>
        </div>
        <div style="flex:1;min-width:220px">
          <label>Senha</label>
          <input id="loginPass" placeholder="ex: 1234" type="password" autocomplete="current-password"/>
        </div>
        <div style="min-width:160px;align-self:end">
          <button id="btnLogin" style="width:100%">Entrar</button>
        </div>
      </div>
      <div class="row" style="margin-top:10px;justify-content:space-between">
        <span class="muted mini" id="loginMsg"></span>
        <span class="pill">Salvo no navegador</span>
      </div>
    </div>
  </section>

  <!-- APP -->
  <section class="hidden" id="appRoot">
    <div class="grid">
      <section class="card" id="mainPanel"></section>
      <aside class="card" id="sidePanel"></aside>
    </div>
  </section>
</main>

<script>
/* =========================
   DB
========================= */
const KEY = "rpg_hub_veuv1";

const ATTR_KEYS = ["ForcaAtletismo","Destreza","Inteligencia","Sabedoria","Carisma"];
const ATTR_LABEL = {
  ForcaAtletismo: "FOR√áA / Atletismo",
  Destreza: "DESTREZA",
  Inteligencia: "INTELIG√äNCIA",
  Sabedoria: "SABEDORIA",
  Carisma: "CARISMA",
};
const SKILL_KEYS = ["Combate","Furtividade","Sobrevivencia","Investigacao","Persuasao","Magia","Rituais","Artesanato"];
const SKILL_LABEL = {
  Combate:"Combate",
  Furtividade:"Furtividade",
  Sobrevivencia:"Sobreviv√™ncia",
  Investigacao:"Investiga√ß√£o",
  Persuasao:"Persuas√£o",
  Magia:"Magia",
  Rituais:"Rituais",
  Artesanato:"Artesanato",
};

function defaultDB(){
  // Ra√ßas padr√£o (as que voc√™ curtiu) + 2 PERFEITAS opostas
  const races = [
    // padr√£o
    {
      id:"human_veil", tier:"padrao", name:"Humano do V√©u",
      lore:"Adaptados ao segredo. O V√©u n√£o apaga suas mem√≥rias por completo.",
      buffs:{ attr:{Carisma:+1}, skill:{Investigacao:+4} },
      perks:["Vers√°til (Carisma +1)", "Farol do V√©u (Investiga√ß√£o +4)"],
      note:"Sinal: olhos brilham quando o V√©u se aproxima."
    },
    {
      id:"elf_twilight", tier:"padrao", name:"Elfo Crepuscular",
      lore:"Filhos das rachaduras; enxergam camadas que outros ignoram.",
      buffs:{ attr:{Inteligencia:+1}, skill:{Furtividade:+4, Investigacao:+4} },
      perks:["Mente refinada (Intelig√™ncia +1)", "Passo silencioso (Furtividade +4)", "Olhar do Crep√∫sculo (Investiga√ß√£o +4)"],
      note:"Sinal: a sombra ‚Äòatrasada‚Äô denuncia seu sangue."
    },
    {
      id:"dwarf_rune", tier:"padrao", name:"An√£o R√∫nico",
      lore:"Forjadores do oculto. Seus s√≠mbolos prendem o imposs√≠vel em metal.",
      buffs:{ attr:{ForcaAtletismo:+1}, skill:{Artesanato:+8} },
      perks:["Vigor (For√ßa/Atletismo +1)", "M√£o R√∫nica (Artesanato +8)"],
      note:"Sinal: runas surgem na pele sob tens√£o."
    },
    {
      id:"dragonborn_veil", tier:"padrao", name:"Draconato do V√©u",
      lore:"A guerra antiga ainda ferve no sangue. Um drag√£o n√£o esquece.",
      buffs:{ attr:{ForcaAtletismo:+1, Carisma:+1}, skill:{Combate:+4} },
      perks:["For√ßa drac√¥nica (For√ßa/Atletismo +1)", "Presen√ßa (Carisma +1)", "Treino de ca√ßa (Combate +4)"],
      note:"Sinal: ar esquenta quando voc√™ se irrita."
    },
    {
      id:"tiefling_abyss", tier:"padrao", name:"Tiefling Abissal",
      lore:"Marcados pelo fundo do mundo. Alguns chamam de ‚Äòmaldi√ß√£o‚Äô, outros de ‚Äòpoder‚Äô.",
      buffs:{ attr:{Carisma:+1}, skill:{Magia:+4, Rituais:+4} },
      perks:["Carisma perigoso (Carisma +1)", "Magia negra (Magia +4)", "Ritos do fundo (Rituais +4)"],
      note:"Sinal: marcas e sombras mais densas ao redor."
    },
    {
      id:"aasimar_ancient", tier:"padrao", name:"Aasimar da Luz Antiga",
      lore:"Carregam brilho antigo demais pra este mundo ‚Äî mas ainda assim, humano.",
      buffs:{ attr:{Sabedoria:+1}, skill:{Persuasao:+4} },
      perks:["Guia (Sabedoria +1)", "Voz que acalma (Persuas√£o +4)"],
      note:"Sinal: um ‚Äòclar√£o‚Äô curto em emo√ß√µes fortes."
    },
    {
      id:"fae_exile", tier:"padrao", name:"Fada Exilada",
      lore:"O Reino Fe√©rico n√£o perdoa‚Ä¶ mas suas rotas continuam abertas.",
      buffs:{ attr:{Destreza:+1}, skill:{Furtividade:+4} },
      perks:["Agilidade fe√©rica (Destreza +1)", "Sumi√ßo (Furtividade +4)"],
      note:"Sinal: brilho de p√≥ fe√©rico quando voc√™ corre."
    },
    {
      id:"veurian", tier:"padrao", name:"V√©uriano",
      lore:"Nascidos do pr√≥prio V√©u. Meio gente, meio ‚Äòfalha da realidade‚Äô.",
      buffs:{ attr:{Inteligencia:+1}, skill:{Investigacao:+4, Rituais:+4} },
      perks:["Mente trincada (Intelig√™ncia +1)", "Senso de falha (Investiga√ß√£o +4)", "Selo instintivo (Rituais +4)"],
      note:"Sinal: por um segundo, voc√™ parece vidro rachado."
    },
    {
      id:"sangrado", tier:"padrao", name:"Sangrado",
      lore:"A guerra corre nas veias. Emo√ß√£o vira for√ßa. For√ßa vira destino.",
      buffs:{ attr:{ForcaAtletismo:+1}, skill:{Combate:+4, Sobrevivencia:+4} },
      perks:["F√∫ria (For√ßa/Atletismo +1)", "Treino brutal (Combate +4)", "Instinto (Sobreviv√™ncia +4)"],
      note:"Sinal: veias vermelhas escuras no esfor√ßo."
    },
    {
      id:"oracle_born", tier:"padrao", name:"Or√°culo Nascido",
      lore:"Voc√™ v√™ fragmentos do amanh√£ ‚Äî mas nunca o suficiente para dormir em paz.",
      buffs:{ attr:{Sabedoria:+1}, skill:{Investigacao:+4} },
      perks:["Vis√£o (Sabedoria +1)", "Ca√ßador de pistas (Investiga√ß√£o +4)"],
      note:"Custo narrativo: vis√µes em momentos tensos."
    },
    {
      id:"shadowborn", tier:"padrao", name:"Sombr√≠deo",
      lore:"Ecos que aprenderam a andar. A sombra n√£o √© aus√™ncia ‚Äî √© mem√≥ria.",
      buffs:{ attr:{Destreza:+1}, skill:{Furtividade:+8} },
      perks:["Passo sem rastro (Destreza +1)", "Sombra viva (Furtividade +8)"],
      note:"Sinal: reflexo parece ‚Äòatrasado‚Äô em espelhos."
    },
    {
      id:"eclipse_wing", tier:"padrao", name:"Alado do Eclipse",
      lore:"Quando luz e sombra brigam, √†s vezes nasce algu√©m no meio.",
      buffs:{ attr:{Carisma:+1, Sabedoria:+1}, skill:{Magia:+4} },
      perks:["Aura dupla (Carisma +1)", "Equil√≠brio (Sabedoria +1)", "Magia de transi√ß√£o (Magia +4)"],
      note:"Sinal: asas espectrais aparecem por instantes."
    },
    {
      id:"arcane_synthetic", tier:"padrao", name:"Sint√©tico Arcano",
      lore:"Constru√≠do ‚Äî n√£o nascido. E mesmo assim‚Ä¶ voc√™ sonha.",
      buffs:{ attr:{Inteligencia:+1}, skill:{Artesanato:+4, Rituais:+4} },
      perks:["L√≥gica (Intelig√™ncia +1)", "Montagem (Artesanato +4)", "Circuito r√∫nico (Rituais +4)"],
      note:"Sinal: runas fracas sob a pele."
    },

    // PERFEITAS (rar√≠ssimas) ‚Äî opostas, ‚Äúnome pesado‚Äù
    {
      id:"perfect_seraph", tier:"perfeita", name:"SERAFIM ABSOLUTO",
      lore:"A luz mais antiga atravessou o V√©u e escolheu um corpo. Isso n√£o era pra acontecer.",
      buffs:{ attr:{Sabedoria:+2, Carisma:+2}, skill:{Persuasao:+8, Magia:+8} },
      perks:["Sabedoria +2", "Carisma +2", "Persuas√£o +8", "Magia +8", "Presen√ßa sagrada (narrativo)"],
      note:"Por essa ra√ßa exige uma troca. (Voc√™ abriu m√£o do controle ‚Äî o mundo escolheu por voc√™.)"
    },
    {
      id:"perfect_abyss", tier:"perfeita", name:"ARQUIABISMO PRIMORDIAL",
      lore:"Uma vontade do fundo do mundo aprendeu a respirar aqui. Sua exist√™ncia √© um erro‚Ä¶ e um poder.",
      buffs:{ attr:{ForcaAtletismo:+2, Inteligencia:+2}, skill:{Combate:+8, Rituais:+8} },
      perks:["For√ßa/Atletismo +2", "Intelig√™ncia +2", "Combate +8", "Rituais +8", "Autoridade do Abismo (narrativo)"],
      note:"Por essa ra√ßa exige uma troca. (Voc√™ abriu m√£o do controle ‚Äî o mundo escolheu por voc√™.)"
    }
  ];

  // Classes: mesmo n√∫mero de ra√ßas (15), com b√¥nus leves em atributos e maiores em per√≠cias (4 em 4)
  const classes = [
    { id:"cls1", name:"Cavaleiro do V√©u", lore:"Guarda de portais e juramentos.", buffs:{attr:{ForcaAtletismo:+1}, skill:{Combate:+4}} },
    { id:"cls2", name:"Arcanista Crepuscular", lore:"Feiti√ßos que atravessam rachaduras.", buffs:{attr:{Inteligencia:+1}, skill:{Magia:+4}} },
    { id:"cls3", name:"Ferreiro R√∫nico", lore:"Runa, metal, destino.", buffs:{attr:{Sabedoria:+1}, skill:{Artesanato:+8}} },
    { id:"cls4", name:"Lan√ßa-Drag√£o", lore:"Ca√ßa e combate contra o imposs√≠vel.", buffs:{attr:{ForcaAtletismo:+1}, skill:{Combate:+8}} },
    { id:"cls5", name:"Hexer do Abismo", lore:"Pactos, custo, poder.", buffs:{attr:{Carisma:+1}, skill:{Rituais:+4, Magia:+4}} },
    { id:"cls6", name:"Arauto da Luz Antiga", lore:"Protege, guia, imp√µe ordem.", buffs:{attr:{Sabedoria:+1}, skill:{Persuasao:+4}} },
    { id:"cls7", name:"Trapaceiro Fe√©rico", lore:"Sumi√ßo, truque, caminho secreto.", buffs:{attr:{Destreza:+1}, skill:{Furtividade:+8}} },
    { id:"cls8", name:"Cart√≥grafo Trincado", lore:"Mapeia falhas do mundo.", buffs:{attr:{Inteligencia:+1}, skill:{Investigacao:+8}} },
    { id:"cls9", name:"Gladiador Sangrado", lore:"Guerra no peito, vit√≥ria no punho.", buffs:{attr:{ForcaAtletismo:+1}, skill:{Combate:+4, Sobrevivencia:+4}} },
    { id:"cls10", name:"Or√°culo de Marfim", lore:"V√™ peda√ßos do amanh√£.", buffs:{attr:{Sabedoria:+1}, skill:{Investigacao:+4}} },
    { id:"cls11", name:"Assassino das Sombras", lore:"Um passo e acabou.", buffs:{attr:{Destreza:+1}, skill:{Furtividade:+4, Combate:+4}} },
    { id:"cls12", name:"Monge do Eclipse", lore:"Equil√≠brio que vira l√¢mina.", buffs:{attr:{Carisma:+1}, skill:{Magia:+4}} },
    { id:"cls13", name:"Engenheiro Arcano", lore:"Artefatos, selos, m√°quinas do V√©u.", buffs:{attr:{Inteligencia:+1}, skill:{Artesanato:+4, Rituais:+4}} },
    { id:"cls14", name:"Guardi√£o Seraf√≠nico", lore:"Uma armadura de luz em forma humana.", buffs:{attr:{Sabedoria:+1}, skill:{Persuasao:+8}} },
    { id:"cls15", name:"Profeta do Fundo", lore:"Ritos que fazem o mundo tremer.", buffs:{attr:{Inteligencia:+1}, skill:{Rituais:+8}} },
  ];

  // Desvantagens (Zomboid style) -> d√£o pontos extras
  const disadvantages = [
    { id:"dv_fobia", name:"Fobia", points:{attr:+1, skillPicks:+1}, desc:"Voc√™ escolhe um medo forte. Pode atrapalhar em cenas tensas." },
    { id:"dv_impulsivo", name:"Impulsivo", points:{attr:+1, skillPicks:+1}, desc:"Provoca√ß√µes te puxam. Decis√µes precipitadas (roleplay)." },
    { id:"dv_marcado", name:"Marcado pelo V√©u", points:{attr:+2, skillPicks:+1}, desc:"Seu ‚Äòsinal‚Äô √© mais vis√≠vel ‚Äî coisas te notam com facilidade." },
    { id:"dv_debito", name:"D√≠vida com a Guilda", points:{attr:+1, skillPicks:+2}, desc:"Um favor perigoso vai ser cobrado (o Mestre decide quando)." },
    { id:"dv_vozes", name:"Vozes na Cabe√ßa", points:{attr:+2, skillPicks:+2}, desc:"Vis√µes/lapsos em momentos de press√£o (narrativo)." },
    { id:"dv_sem_sorte", name:"Sem Sorte", points:{attr:+1, skillPicks:+1}, desc:"1x por sess√£o o Mestre pode puxar um azar pequeno." },
  ];

  return {
    users: [
      { id:"u_master", username:"mestre", password:"1234", role:"master" },
      { id:"u_p1", username:"player1", password:"1234", role:"player", playerId:"p1" },
    ],
    players: [
      {
        id:"p1",
        username:"player1",
        xp: 0,
        inventory: [],
        characterCreated: false,
        character: {
          avatarDataUrl: "",
          charName: "Player 1",
          preferredRaceId: "human_veil",
          classId: "cls1",
          finalRaceId: "",
          attrs: mkAttrsZero(),
          skills: mkSkillsZero(),
          disadvantages: [],
          pools: { attrBase: 10, skillPicksBase: 8 } // skill picks: cada pick = +4 em uma per√≠cia
        },
        log: [{ts: Date.now(), text:"Conta criada. Primeiro login libera cria√ß√£o."}]
      }
    ],
    races,
    classes,
    disadvantages,
    session: { userId:null }
  };
}

/* =========================
   Helpers
========================= */
const $ = (id)=>document.getElementById(id);

function mkAttrsZero(){
  const o = {};
  for(const k of ATTR_KEYS) o[k]=0;
  return o;
}
function mkSkillsZero(){
  const o = {};
  for(const k of SKILL_KEYS) o[k]=0;
  return o;
}
function escapeHTML(str){
  return String(str||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function nowStr(ts){ return new Date(ts).toLocaleString(); }
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

function loadDB(){
  const raw = localStorage.getItem(KEY);
  if(!raw){
    const db = defaultDB();
    localStorage.setItem(KEY, JSON.stringify(db));
    return db;
  }
  try { return JSON.parse(raw); }
  catch {
    const db = defaultDB();
    localStorage.setItem(KEY, JSON.stringify(db));
    return db;
  }
}
function saveDB(db){ localStorage.setItem(KEY, JSON.stringify(db)); }

let DB = loadDB();

function findUserBySession(){
  const uid = DB.session.userId;
  if(!uid) return null;
  return DB.users.find(u=>u.id===uid) || null;
}
function getPlayer(pid){ return DB.players.find(p=>p.id===pid); }
function getRace(rid){ return DB.races.find(r=>r.id===rid) || null; }
function getClass(cid){ return DB.classes.find(c=>c.id===cid) || null; }
function getDisadv(did){ return DB.disadvantages.find(d=>d.id===did) || null; }

function toast(msg, good=true){
  const el = $("loginMsg");
  if(el){
    el.textContent = msg;
    el.className = "muted mini " + (good ? "ok":"bad");
    setTimeout(()=>{ el.textContent=""; el.className="muted mini"; }, 2600);
  } else alert(msg);
}

/* =========================
   Auth
========================= */
function login(username, password){
  const u = DB.users.find(x=>x.username===username && x.password===password);
  if(!u) return { ok:false, msg:"Usu√°rio ou senha inv√°lidos." };
  DB.session.userId = u.id;
  saveDB(DB);
  return { ok:true, user:u };
}
function logout(){
  DB.session.userId = null;
  saveDB(DB);
  render();
}

/* =========================
   Pools / Points
========================= */
function disadvBonus(player){
  let attr=0, skillPicks=0;
  for(const id of (player.character.disadvantages||[])){
    const d = getDisadv(id);
    if(d){ attr += (d.points?.attr||0); skillPicks += (d.points?.skillPicks||0); }
  }
  return {attr, skillPicks};
}
function totalAttrPoints(player){
  const base = player.character.pools?.attrBase ?? 10;
  return base + disadvBonus(player).attr;
}
function totalSkillPicks(player){
  const base = player.character.pools?.skillPicksBase ?? 8;
  return base + disadvBonus(player).skillPicks;
}
function spentAttrPoints(player){
  let sum=0;
  for(const k of ATTR_KEYS) sum += Number(player.character.attrs?.[k]||0);
  return sum;
}
function spentSkillPicks(player){
  // cada pick = +4
  let picks=0;
  for(const k of SKILL_KEYS) picks += Math.floor(Number(player.character.skills?.[k]||0)/4);
  return picks;
}

/* =========================
   Wheel (sem mostrar chances)
   - Resultado pode ser: ra√ßa preferida, outra padr√£o, ou uma perfeita rara
========================= */
function buildWheelSegments(preferredRaceId){
  // Segments: todas padr√£o + 2 perfeitas
  const perfect = DB.races.filter(r=>r.tier==="perfeita");
  const standard = DB.races.filter(r=>r.tier!=="perfeita");
  const preferred = standard.find(r=>r.id===preferredRaceId) || standard[0];

  // Pesos (n√£o exibidos):
  // - Perfeitas: raras (bem baixo)
  // - Preferida: mais alta
  // - Outras: normal
  const segs = [];
  const perfectWeightEach = 1;       // rar√≠ssimo (n√£o 7,5% exposto)
  const preferredWeight = 9;         // aumenta chance da escolhida
  const otherWeight = 3;             // outras podem cair

  for(const r of standard){
    segs.push({ race:r, w: (r.id===preferred.id ? preferredWeight : otherWeight) });
  }
  for(const r of perfect){
    segs.push({ race:r, w: perfectWeightEach });
  }

  // converte pesos em √¢ngulos
  const total = segs.reduce((s,x)=>s+x.w,0);
  let acc=0;
  const segments = segs.map(s=>{
    const start = acc/total*Math.PI*2;
    acc += s.w;
    const end = acc/total*Math.PI*2;
    return { race:s.race, start, end, w:s.w };
  });
  return segments;
}
function weightedPick(segments){
  const total = segments.reduce((s,x)=>s+x.w,0);
  let roll = Math.random()*total;
  for(const seg of segments){
    roll -= seg.w;
    if(roll<=0) return seg;
  }
  return segments[segments.length-1];
}
function segmentAngleToStopOn(seg){
  const mid=(seg.start+seg.end)/2;
  return (-Math.PI/2) - mid;
}
function drawWheel(ctx, segments, rotation=0){
  const {width:w,height:h} = ctx.canvas;
  ctx.clearRect(0,0,w,h);
  const cx=w/2, cy=h/2;
  const radius=Math.min(w,h)*0.45;

  ctx.save();
  ctx.translate(cx,cy);
  ctx.rotate(rotation);

  for(let i=0;i<segments.length;i++){
    const seg=segments[i];
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.arc(0,0,radius, seg.start, seg.end);
    ctx.closePath();

    const isPerfect = seg.race.tier==="perfeita";
    ctx.fillStyle = isPerfect ? "rgba(245,194,75,.25)" : (i%2===0 ? "#1b2533" : "#15202d");
    ctx.fill();

    ctx.strokeStyle="#223042";
    ctx.lineWidth=2;
    ctx.stroke();

    const mid=(seg.start+seg.end)/2;
    ctx.save();
    ctx.rotate(mid);
    ctx.translate(radius*0.62,0);
    ctx.rotate(Math.PI/2);
    ctx.fillStyle="#e8f0fb";
    ctx.font="900 12px system-ui";
    const label = seg.race.name.length>18 ? seg.race.name.slice(0,18)+"‚Ä¶" : seg.race.name;
    ctx.fillText(label, -ctx.measureText(label).width/2, 0);
    ctx.restore();
  }

  ctx.beginPath();
  ctx.arc(0,0,radius*0.18,0,Math.PI*2);
  ctx.fillStyle="#0c131c";
  ctx.fill();
  ctx.strokeStyle="#223042";
  ctx.lineWidth=2;
  ctx.stroke();

  ctx.fillStyle="#8aa0b6";
  ctx.font="950 12px system-ui";
  const t="GIRAR";
  ctx.fillText(t, -ctx.measureText(t).width/2, 4);

  ctx.restore();
}

/* =========================
   Bonuses apply
   - No momento que a roleta termina, aplica b√¥nus da ra√ßa FINAL
   - E aplica b√¥nus da classe escolhida
========================= */
function applyBonusesToSheet(player, race, cls){
  // aplica b√¥nus diretos (somando em cima do que o player distribuiu)
  const a = player.character.attrs;
  const s = player.character.skills;

  const addAttr = (k,n)=>{ a[k] = Number(a[k]||0) + (n||0); };
  const addSkill = (k,n)=>{ s[k] = Number(s[k]||0) + (n||0); };

  const rb = race?.buffs || {};
  const cb = cls?.buffs || {};

  // attrs
  for(const [k,v] of Object.entries(rb.attr||{})) addAttr(k, v);
  for(const [k,v] of Object.entries(cb.attr||{})) addAttr(k, v);

  // skills (multiplo de 4 j√°)
  for(const [k,v] of Object.entries(rb.skill||{})) addSkill(k, v);
  for(const [k,v] of Object.entries(cb.skill||{})) addSkill(k, v);
}

/* =========================
   Derived resources
========================= */
function calcDerived(player){
  const a = player.character.attrs;

  const STR = Number(a.ForcaAtletismo||0);
  const DEX = Number(a.Destreza||0);
  const INT = Number(a.Inteligencia||0);
  const WIS = Number(a.Sabedoria||0);
  const CHA = Number(a.Carisma||0);

  const vida = 60 + STR*12 + WIS*6;
  const defesa = 10 + DEX*2 + WIS*2 + STR*1;
  const velocidade = 10 + DEX*3 + Math.floor(STR*0.5);
  const foco = 25 + INT*8 + WIS*6 + Math.floor(CHA*2);

  // max visual (s√≥ pra barra ficar bonita)
  const maxVida = 220;
  const maxDef = 60;
  const maxVel = 60;
  const maxFoco = 220;

  return {
    vida, defesa, velocidade, foco,
    pctVida: clamp(Math.round(vida/maxVida*100), 0, 100),
    pctDef: clamp(Math.round(defesa/maxDef*100), 0, 100),
    pctVel: clamp(Math.round(velocidade/maxVel*100), 0, 100),
    pctFoco: clamp(Math.round(foco/maxFoco*100), 0, 100),
  };
}

/* =========================
   Master tools
========================= */
function masterCreatePlayerLogin(displayName, username, password){
  if(DB.users.some(u=>u.username===username)) return {ok:false, msg:"Esse usu√°rio j√° existe."};

  const playerId = "p" + Math.random().toString(16).slice(2,8);
  const userId = "u_" + Math.random().toString(16).slice(2,8);

  DB.players.push({
    id: playerId,
    username,
    xp: 0,
    inventory: [],
    characterCreated: false,
    character: {
      avatarDataUrl: "",
      charName: displayName,
      preferredRaceId: "human_veil",
      classId: "cls1",
      finalRaceId: "",
      attrs: mkAttrsZero(),
      skills: mkSkillsZero(),
      disadvantages: [],
      pools: { attrBase: 10, skillPicksBase: 8 }
    },
    log: [{ts:Date.now(), text:"Conta criada pelo Mestre. Primeiro login libera cria√ß√£o."}]
  });

  DB.users.push({ id:userId, username, password, role:"player", playerId });

  saveDB(DB);
  return {ok:true, msg:"Player criado! Login pronto."};
}
function masterResetCharacter(playerId){
  const p = getPlayer(playerId);
  if(!p) return;
  p.characterCreated = false;
  p.character.finalRaceId = "";
  p.character.attrs = mkAttrsZero();
  p.character.skills = mkSkillsZero();
  p.character.disadvantages = [];
  p.character.preferredRaceId = "human_veil";
  p.character.classId = "cls1";
  p.log.unshift({ts:Date.now(), text:"Mestre resetou o personagem (recria√ß√£o liberada)."});
  saveDB(DB);
}
function masterDeletePlayer(playerId){
  const p = getPlayer(playerId);
  if(!p) return;
  // remove user login
  DB.users = DB.users.filter(u=>u.playerId!==playerId);
  // remove player
  DB.players = DB.players.filter(pp=>pp.id!==playerId);
  saveDB(DB);
}
function masterGiveXP(playerId, amount, reason){
  const p = getPlayer(playerId);
  if(!p) return;
  const a = Number(amount);
  if(!Number.isFinite(a)) return;
  p.xp = Math.max(0, p.xp + a);
  p.log.unshift({ts:Date.now(), text:`XP ${a>=0?"+":""}${a} ‚Äî ${reason||"sem motivo"}`});
  saveDB(DB);
}
function masterGiveItem(playerId, itemName){
  const p = getPlayer(playerId);
  if(!p) return;
  const name = String(itemName||"").trim();
  if(!name) return;
  p.inventory.unshift({ id:"it_"+Math.random().toString(16).slice(2,8), name, ts:Date.now() });
  p.log.unshift({ts:Date.now(), text:`Item recebido: ${name}`});
  saveDB(DB);
}
function masterRemoveItem(playerId, itemId){
  const p = getPlayer(playerId);
  if(!p) return;
  const it = p.inventory.find(x=>x.id===itemId);
  p.inventory = p.inventory.filter(x=>x.id!==itemId);
  p.log.unshift({ts:Date.now(), text:`Item removido: ${it?.name||"‚Äî"}`});
  saveDB(DB);
}

/* =========================
   UI Render
========================= */
function render(){
  const user = findUserBySession();

  $("btnLogout").classList.toggle("hidden", !user);
  $("loginCard").classList.toggle("hidden", !!user);
  $("appRoot").classList.toggle("hidden", !user);

  $("sessionPill").textContent = user
    ? `Sess√£o: ${user.role==="master" ? "Mestre" : "Player"} (${user.username})`
    : "Sess√£o: n√£o logado";

  if(!user) return;

  if(user.role==="master") renderMaster();
  else renderPlayer(user.playerId);
}

function renderMaster(){
  const main = $("mainPanel");
  main.innerHTML = `
    <h2 style="margin:0 0 6px 0;font-size:16px">Painel do Mestre</h2>
    <p class="muted" style="margin-top:0">
      Voc√™ cria logins, d√° XP/itens, reseta e deleta personagens. No primeiro login, o player faz a cria√ß√£o com roleta.
    </p>

    <div class="divider"></div>

    <h3 style="margin:0 0 8px 0;font-size:14px">Criar login de player</h3>
    <div class="row">
      <div style="flex:1;min-width:220px">
        <label>Nome do personagem (pode mudar depois)</label>
        <input id="m_newName" placeholder="ex: Kael, Nyra, Amon...">
      </div>
      <div style="flex:1;min-width:200px">
        <label>Usu√°rio</label>
        <input id="m_newUser" placeholder="ex: player2">
      </div>
      <div style="flex:1;min-width:200px">
        <label>Senha</label>
        <input id="m_newPass" placeholder="ex: 1234" type="password">
      </div>
      <div style="min-width:160px;align-self:end">
        <button id="m_btnCreate" style="width:100%">Criar</button>
      </div>
    </div>
    <div class="muted mini" id="m_msg" style="margin-top:10px"></div>

    <div class="divider"></div>

    <h3 style="margin:0 0 8px 0;font-size:14px">Gerenciar player</h3>
    <div class="row">
      <div style="flex:1;min-width:260px">
        <label>Player</label>
        <select id="m_selPlayer"></select>
      </div>
      <div style="min-width:120px">
        <label>XP</label>
        <input id="m_xpAmt" type="number" value="50">
      </div>
      <div style="flex:1;min-width:260px">
        <label>Motivo</label>
        <input id="m_xpReason" placeholder="ex: miss√£o, combate, roleplay...">
      </div>
      <div style="min-width:160px;align-self:end">
        <button id="m_btnXP" style="width:100%">Dar XP</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div style="flex:1;min-width:360px">
        <label>Dar item</label>
        <input id="m_itemName" placeholder="ex: Rel√≠quia, po√ß√£o, arma r√∫nica...">
      </div>
      <div style="min-width:160px;align-self:end">
        <button id="m_btnItem" class="secondary" style="width:100%">Dar Item</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="m_btnReset" class="secondary">Resetar personagem (recriar)</button>
      <button id="m_btnDelete" class="danger">Deletar player</button>
      <button id="m_btnView" class="secondary">Ver ficha</button>
    </div>

    <div class="divider"></div>

    <div class="warn">
      <b>Nota:</b>
      <div class="muted mini">Ra√ßas PERFEITAS existem, mas s√£o rar√≠ssimas e s√≥ aparecem na roleta. O site n√£o mostra chances.</div>
    </div>
  `;

  const side = $("sidePanel");
  side.innerHTML = `
    <h2 style="margin:0 0 6px 0;font-size:16px">Players</h2>
    <p class="muted" style="margin-top:0">Status de cria√ß√£o + ra√ßa final.</p>
    <div id="roster"></div>
  `;

  const sel = $("m_selPlayer");
  sel.innerHTML = DB.players.map(p=>{
    const done = p.characterCreated ? "‚úÖ" : "‚è≥";
    return `<option value="${p.id}">${done} ${escapeHTML(p.character.charName||p.username)} ‚Äî @${escapeHTML(p.username)} (XP ${p.xp})</option>`;
  }).join("");

  $("m_btnCreate").onclick = ()=>{
    const name = $("m_newName").value.trim();
    const user = $("m_newUser").value.trim();
    const pass = $("m_newPass").value.trim();
    const msg = $("m_msg");
    msg.textContent = "";
    if(!name || !user || !pass){
      msg.textContent = "Preencha nome, usu√°rio e senha.";
      msg.className = "muted mini bad";
      return;
    }
    const res = masterCreatePlayerLogin(name, user, pass);
    msg.textContent = res.msg;
    msg.className = "muted mini " + (res.ok ? "ok" : "bad");
    DB = loadDB();
    render();
  };

  $("m_btnXP").onclick = ()=>{
    const pid = sel.value;
    masterGiveXP(pid, $("m_xpAmt").value, $("m_xpReason").value.trim());
    DB = loadDB();
    render();
  };

  $("m_btnItem").onclick = ()=>{
    const pid = sel.value;
    masterGiveItem(pid, $("m_itemName").value);
    DB = loadDB();
    render();
  };

  $("m_btnReset").onclick = ()=>{
    const pid = sel.value;
    if(confirm("Resetar personagem? (o player vai criar tudo de novo)")){
      masterResetCharacter(pid);
      DB = loadDB();
      render();
    }
  };

  $("m_btnDelete").onclick = ()=>{
    const pid = sel.value;
    if(confirm("Deletar esse player e o login dele?")){
      masterDeletePlayer(pid);
      DB = loadDB();
      render();
    }
  };

  $("m_btnView").onclick = ()=>{
    openPlayerModal(sel.value);
  };

  renderRoster();
}

function renderRoster(){
  const wrap = $("roster");
  if(!wrap) return;
  wrap.innerHTML = "";
  DB.players.forEach(p=>{
    const race = p.character.finalRaceId ? getRace(p.character.finalRaceId)?.name : "‚Äî";
    const div = document.createElement("div");
    div.className = "card";
    div.style.padding="12px";
    div.style.marginBottom="10px";
    div.style.background="#0c131c";
    div.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div>
          <div style="font-weight:950">${escapeHTML(p.character.charName||p.username)}</div>
          <div class="muted mini">Criado: ${p.characterCreated ? "sim" : "n√£o"} ‚Ä¢ Ra√ßa: ${escapeHTML(race)} ‚Ä¢ XP: ${p.xp}</div>
        </div>
        <button class="secondary" data-open="${p.id}">Abrir</button>
      </div>
    `;
    wrap.appendChild(div);
    div.querySelector("button").onclick = ()=>openPlayerModal(p.id);
  });
}

function openPlayerModal(pid){
  const p = getPlayer(pid);
  if(!p) return;

  const race = p.character.finalRaceId ? getRace(p.character.finalRaceId) : null;
  const cls = getClass(p.character.classId);

  const derived = p.characterCreated ? calcDerived(p) : null;

  const html = `
    <div class="overlay" id="ov">
      <div class="modal">
        <div class="modalHeader">
          <div>
            <div style="font-size:16px;font-weight:950">${escapeHTML(p.character.charName||p.username)}</div>
            <div class="muted mini">@${escapeHTML(p.username)} ‚Ä¢ XP ${p.xp} ‚Ä¢ Criado: ${p.characterCreated ? "sim" : "n√£o"}</div>
          </div>
          <button class="danger" id="close">Fechar</button>
        </div>
        <div class="divider"></div>

        <div class="grid" style="grid-template-columns:1fr;gap:12px">
          <div class="card" style="background:#0c131c">
            <div class="row" style="justify-content:space-between">
              <b>Ra√ßa</b>
              ${race?.tier==="perfeita" ? `<span class="tag perfect">PERFEITA</span>` : `<span class="tag">padr√£o</span>`}
            </div>
            <div class="muted mini" style="margin-top:6px">${escapeHTML(race?.name||"‚Äî")}</div>
            <div class="muted mini" style="margin-top:6px">${escapeHTML(race?.note||"")}</div>
          </div>

          <div class="card" style="background:#0c131c">
            <div class="row" style="justify-content:space-between"><b>Classe</b><span class="tag lore">Guerra do V√©u</span></div>
            <div class="muted mini" style="margin-top:6px">${escapeHTML(cls?.name||"‚Äî")}</div>
            <div class="muted mini" style="margin-top:6px">${escapeHTML(cls?.lore||"")}</div>
          </div>

          <div class="card" style="background:#0c131c">
            <b>Atributos</b>
            <div class="divider"></div>
            ${ATTR_KEYS.map(k=>`
              <div class="row" style="justify-content:space-between">
                <span>${ATTR_LABEL[k]}</span><b>${Number(p.character.attrs[k]||0)}</b>
              </div>
            `).join("")}
          </div>

          <div class="card" style="background:#0c131c">
            <b>Per√≠cias</b>
            <div class="divider"></div>
            ${SKILL_KEYS.map(k=>`
              <div class="row" style="justify-content:space-between">
                <span>${SKILL_LABEL[k]}</span><b>${Number(p.character.skills[k]||0)}</b>
              </div>
            `).join("")}
          </div>

          ${derived ? `
            <div class="card" style="background:#0c131c">
              <b>Barras</b>
              <div class="divider"></div>
              <div class="row" style="gap:10px;flex-wrap:wrap">
                <span class="pill">Vida: <b>${derived.vida}</b></span>
                <span class="pill">Defesa: <b>${derived.defesa}</b></span>
                <span class="pill">Velocidade: <b>${derived.velocidade}</b></span>
                <span class="pill">Foco do V√©u: <b>${derived.foco}</b></span>
              </div>
            </div>
          ` : ``}

          <div class="card" style="background:#0c131c">
            <b>Invent√°rio</b>
            <div class="divider"></div>
            <div class="muted mini">${(p.inventory||[]).slice(0,12).map(it=>`‚Ä¢ ${escapeHTML(it.name)}`).join("<br>") || "‚Äî"}</div>
          </div>

          <div class="card" style="background:#0c131c">
            <b>Log</b>
            <div class="divider"></div>
            <div class="muted mini" style="max-height:220px;overflow:auto">
              ${(p.log||[]).slice(0,15).map(l=>`‚Ä¢ [${nowStr(l.ts)}] ${escapeHTML(l.text)}`).join("<br>")}
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  const ov = document.createElement("div");
  ov.innerHTML = html;
  document.body.appendChild(ov.firstElementChild);
  document.getElementById("close").onclick = ()=>document.getElementById("ov").remove();
  document.getElementById("ov").addEventListener("click",(e)=>{ if(e.target.id==="ov") e.target.remove(); });
}

/* =========================
   Player UI
========================= */
function renderPlayer(playerId){
  const p = getPlayer(playerId);
  const main = $("mainPanel");
  const side = $("sidePanel");

  if(!p.characterCreated){
    renderCharacterCreator(p);
    side.innerHTML = `
      <h2 style="margin:0 0 6px 0;font-size:16px">Guerra do V√©u</h2>
      <p class="muted" style="margin-top:0">
        Voc√™ escolhe uma <b>ra√ßa preferida</b> e uma <b>classe</b>. No final, a <b>roleta</b> decide sua ra√ßa final.
        O que cair fica <b>travado</b>.
      </p>
      <div class="warn">
        <b>Importante</b>
        <div class="muted mini">
          Sua ra√ßa final pode ser a preferida‚Ä¶ ou outra. Existem ra√ßas rar√≠ssimas ‚ÄúPerfeitas‚Äù que s√≥ aparecem pela roleta.
          O site n√£o exibe porcentagens.
        </div>
      </div>
    `;
    return;
  }

  const race = getRace(p.character.finalRaceId);
  const cls = getClass(p.character.classId);
  const d = calcDerived(p);

  main.innerHTML = `
    <h2 style="margin:0 0 6px 0;font-size:16px">Ficha do Player</h2>

    <div class="row" style="justify-content:space-between;align-items:flex-start">
      <div class="row" style="gap:14px">
        <div class="avatarBox" id="avatarPreviewBox">
          ${p.character.avatarDataUrl ? `<img src="${p.character.avatarDataUrl}" alt="avatar">` : `<span class="muted mini">sem imagem</span>`}
        </div>
        <div>
          <div style="font-size:18px;font-weight:950">${escapeHTML(p.character.charName||p.username)}</div>
          <div class="muted mini">
            Classe: <b>${escapeHTML(cls?.name||"‚Äî")}</b> ‚Ä¢ Ra√ßa: <b>${escapeHTML(race?.name||"‚Äî")}</b>
          </div>
          ${race?.tier==="perfeita" ? `<div class="tag perfect" style="margin-top:8px">Por essa ra√ßa exige uma troca</div>` : ``}
          <div class="muted mini" style="margin-top:8px">${escapeHTML(race?.note||"")}</div>

          <div class="row" style="margin-top:10px">
            <label style="min-width:220px">Alterar imagem (liberado)</label>
            <input id="avatarChange" type="file" accept="image/*">
          </div>
        </div>
      </div>

      <span class="pill">XP: <b>${p.xp}</b></span>
    </div>

    <div class="divider"></div>

    <div class="kpiGrid">
      ${renderKpi("Vida", d.vida, d.pctVida, "var(--red)")}
      ${renderKpi("Defesa", d.defesa, d.pctDef, "var(--gold)")}
      ${renderKpi("Velocidade", d.velocidade, d.pctVel, "var(--cyan)")}
      ${renderKpi("Foco do V√©u", d.foco, d.pctFoco, "var(--violet)")}
    </div>

    <div class="divider"></div>

    <div class="grid" style="grid-template-columns:1fr;gap:12px">
      <div class="card" style="background:#0c131c">
        <div class="row" style="justify-content:space-between">
          <b>Buffs da Ra√ßa</b>
          ${race?.tier==="perfeita" ? `<span class="tag perfect">PERFEITA</span>` : `<span class="tag">padr√£o</span>`}
        </div>
        <div class="divider"></div>
        <div class="muted mini">${(race?.perks||[]).map(x=>`‚Ä¢ ${escapeHTML(x)}`).join("<br>") || "‚Äî"}</div>
      </div>

      <div class="card" style="background:#0c131c">
        <b>Buffs da Classe</b>
        <div class="divider"></div>
        <div class="muted mini">
          ‚Ä¢ ${escapeHTML(cls?.lore||"‚Äî")}<br>
          ${formatBuffs(cls?.buffs)}
        </div>
      </div>
    </div>
  `;

  side.innerHTML = `
    <h2 style="margin:0 0 6px 0;font-size:16px">Atributos e Per√≠cias</h2>
    <p class="muted" style="margin-top:0">Valores finais (j√° incluem b√¥nus de ra√ßa e classe).</p>

    <div class="card" style="background:#0c131c">
      <b>Atributos</b>
      <div class="divider"></div>
      ${ATTR_KEYS.map(k=>`<div class="row" style="justify-content:space-between"><span>${ATTR_LABEL[k]}</span><b>${Number(p.character.attrs[k]||0)}</b></div>`).join("")}
    </div>

    <div class="divider"></div>

    <div class="card" style="background:#0c131c">
      <b>Per√≠cias</b>
      <div class="divider"></div>
      ${SKILL_KEYS.map(k=>`<div class="row" style="justify-content:space-between"><span>${SKILL_LABEL[k]}</span><b>${Number(p.character.skills[k]||0)}</b></div>`).join("")}
    </div>

    <div class="divider"></div>

    <div class="card" style="background:#0c131c">
      <div class="row" style="justify-content:space-between">
        <b>Invent√°rio</b>
        <span class="pill">${(p.inventory||[]).length} itens</span>
      </div>
      <div class="divider"></div>
      <div class="muted mini" style="max-height:220px;overflow:auto">
        ${(p.inventory||[]).map(it=>`‚Ä¢ ${escapeHTML(it.name)}`).join("<br>") || "‚Äî"}
      </div>
    </div>

    <div class="divider"></div>

    <div class="card" style="background:#0c131c">
      <b>Di√°rio</b>
      <div class="divider"></div>
      <div class="muted mini" style="max-height:220px;overflow:auto">
        ${(p.log||[]).slice(0,20).map(l=>`‚Ä¢ [${nowStr(l.ts)}] ${escapeHTML(l.text)}`).join("<br>") || "‚Äî"}
      </div>
    </div>
  `;

  // imagem pode mudar depois
  const inp = $("avatarChange");
  inp.onchange = async ()=>{
    const file = inp.files?.[0];
    if(!file) return;
    const url = await fileToDataUrl(file);
    const p2 = getPlayer(playerId);
    p2.character.avatarDataUrl = url;
    p2.log.unshift({ts:Date.now(), text:"Imagem do personagem atualizada."});
    saveDB(DB);
    DB = loadDB();
    render();
  };
}

function renderKpi(title, value, pct, color){
  return `
    <div class="kpiBox">
      <div class="kpiTitle"><b>${escapeHTML(title)}</b><span class="kpiValue">${value}</span></div>
      <div class="kpiBar"><div style="width:${pct}%;background:${color}"></div></div>
      <div class="muted mini" style="margin-top:8px">${pct}%</div>
    </div>
  `;
}
function formatBuffs(buffs){
  if(!buffs) return "";
  const parts = [];
  if(buffs.attr){
    for(const [k,v] of Object.entries(buffs.attr)){
      const lbl = ATTR_LABEL[k] || k;
      if(v) parts.push(`‚Ä¢ ${lbl} ${v>0?"+":""}${v}`);
    }
  }
  if(buffs.skill){
    for(const [k,v] of Object.entries(buffs.skill)){
      const lbl = SKILL_LABEL[k] || k;
      if(v) parts.push(`‚Ä¢ ${lbl} ${v>0?"+":""}${v}`);
    }
  }
  return parts.length ? parts.join("<br>") : "";
}

/* =========================
   Character Creator (Tabs)
========================= */
function renderCharacterCreator(player){
  const main = $("mainPanel");
  const c = player.character;

  // garantia
  if(!c.attrs) c.attrs = mkAttrsZero();
  if(!c.skills) c.skills = mkSkillsZero();
  if(!c.disadvantages) c.disadvantages = [];
  if(!c.pools) c.pools = { attrBase:10, skillPicksBase:8 };
  if(!c.preferredRaceId) c.preferredRaceId = "human_veil";
  if(!c.classId) c.classId = "cls1";

  const attrTotal = totalAttrPoints(player);
  const attrSpent = spentAttrPoints(player);
  const attrLeft = attrTotal - attrSpent;

  const skillPicksTotal = totalSkillPicks(player);
  const skillPicksSpent = spentSkillPicks(player);
  const skillPicksLeft = skillPicksTotal - skillPicksSpent;

  main.innerHTML = `
    <h2 style="margin:0 0 6px 0;font-size:16px">Cria√ß√£o de personagem (primeiro login)</h2>
    <p class="muted" style="margin-top:0">
      Escolha <b>ra√ßa preferida</b> e <b>classe</b>, defina <b>atributos</b> e <b>per√≠cias</b>, pegue <b>desvantagens</b> para ganhar pontos
      e no final confirme e gire a <b>roleta</b>.
    </p>

    <div class="row" style="justify-content:space-between">
      <span class="pill">Atributos: <b>${attrLeft}</b> restantes</span>
      <span class="pill">Per√≠cias: <b>${skillPicksLeft}</b> sele√ß√µes restantes (cada sele√ß√£o = +4)</span>
      <span class="pill">Desvantagens: <b>${(c.disadvantages||[]).length}</b></span>
    </div>

    <div class="divider"></div>

    <div class="row" style="align-items:flex-start">
      <div class="avatarBox" id="avatarPreview">
        ${c.avatarDataUrl ? `<img src="${c.avatarDataUrl}" alt="avatar">` : `<span class="muted mini">Adicionar imagem</span>`}
      </div>
      <div style="flex:1;min-width:240px">
        <label>Imagem do personagem</label>
        <input id="avatarInput" type="file" accept="image/*">
        <div class="muted mini" style="margin-top:6px">A imagem fica salva no navegador.</div>

        <div class="row" style="margin-top:12px">
          <div style="flex:1;min-width:220px">
            <label>Nome do personagem</label>
            <input id="charName" value="${escapeHTML(c.charName||"")}" placeholder="ex: Kael, Nyra...">
          </div>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="tabs">
      <button class="tabBtn active" data-tab="tabRaces">Ra√ßas</button>
      <button class="tabBtn" data-tab="tabClasses">Classes</button>
      <button class="tabBtn" data-tab="tabAttrs">Atributos</button>
      <button class="tabBtn" data-tab="tabSkills">Per√≠cias</button>
      <button class="tabBtn" data-tab="tabDisadv">Desvantagens</button>
    </div>

    <div class="tabPanel" id="tabRaces"></div>
    <div class="tabPanel hidden" id="tabClasses"></div>
    <div class="tabPanel hidden" id="tabAttrs"></div>
    <div class="tabPanel hidden" id="tabSkills"></div>
    <div class="tabPanel hidden" id="tabDisadv"></div>

    <div class="divider"></div>

    <div class="row" style="justify-content:flex-end">
      <button class="secondary" id="btnPreview">Ver resumo</button>
      <button id="btnConfirm" ${attrLeft<0 || skillPicksLeft<0 ? "disabled":""}>Confirmar e girar roleta</button>
    </div>

    ${(attrLeft<0 || skillPicksLeft<0) ? `<div class="warn" style="margin-top:12px"><b class="bad">Voc√™ passou do limite de pontos.</b> Ajuste antes de confirmar.</div>` : ``}
  `;

  // Tabs logic
  document.querySelectorAll(".tabBtn").forEach(btn=>{
    btn.onclick = ()=>{
      document.querySelectorAll(".tabBtn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const id = btn.dataset.tab;
      ["tabRaces","tabClasses","tabAttrs","tabSkills","tabDisadv"].forEach(t=>{
        document.getElementById(t).classList.toggle("hidden", t!==id);
      });
      // re-render that panel for updated values
      if(id==="tabRaces") renderRaceTab(player.id);
      if(id==="tabClasses") renderClassTab(player.id);
      if(id==="tabAttrs") renderAttrTab(player.id);
      if(id==="tabSkills") renderSkillTab(player.id);
      if(id==="tabDisadv") renderDisadvTab(player.id);
    };
  });

  // initial panels
  renderRaceTab(player.id);
  renderClassTab(player.id);
  renderAttrTab(player.id);
  renderSkillTab(player.id);
  renderDisadvTab(player.id);

  // avatar
  $("avatarInput").onchange = async ()=>{
    const f = $("avatarInput").files?.[0];
    if(!f) return;
    const url = await fileToDataUrl(f);
    const p2 = getPlayer(player.id);
    p2.character.avatarDataUrl = url;
    saveDB(DB); DB = loadDB();
    renderCharacterCreator(getPlayer(player.id));
  };

  // name
  $("charName").oninput = (e)=>{
    const p2 = getPlayer(player.id);
    p2.character.charName = e.target.value;
    saveDB(DB);
  };

  // buttons
  $("btnPreview").onclick = ()=>openCreationSummary(player.id, false);
  $("btnConfirm").onclick = ()=>{
    const p2 = getPlayer(player.id);
    // validate pools
    if(spentAttrPoints(p2) > totalAttrPoints(p2)){ alert("Atributos acima do limite."); return; }
    if(spentSkillPicks(p2) > totalSkillPicks(p2)){ alert("Per√≠cias acima do limite."); return; }
    openCreationSummary(player.id, true);
  };
}

function renderRaceTab(playerId){
  const p = getPlayer(playerId);
  const tab = $("tabRaces");
  const preferred = p.character.preferredRaceId;

  const standardRaces = DB.races.filter(r=>r.tier!=="perfeita"); // perfeitas n√£o s√£o escolh√≠veis aqui
  tab.innerHTML = `
    <div class="row" style="justify-content:space-between">
      <div>
        <b>Escolha sua ra√ßa preferida</b>
        <div class="muted mini">A roleta pode respeitar sua escolha‚Ä¶ ou te surpreender.</div>
      </div>
      <span class="tag lore">Preferida (n√£o garante)</span>
    </div>
    <div class="divider"></div>
    <div class="selectGrid">
      ${standardRaces.map(r=>{
        const sel = r.id===preferred;
        return `
          <div class="selectCard ${sel ? "selectedGlow":""}">
            <div class="left">
              <div class="row" style="justify-content:space-between;gap:10px">
                <b>${escapeHTML(r.name)}</b>
                <span class="tag">padr√£o</span>
              </div>
              <div class="muted mini" style="margin-top:6px">${escapeHTML(r.lore)}</div>
              <div class="muted mini" style="margin-top:8px">
                <b>Buffs:</b><br>${formatBuffs(r.buffs)}
              </div>
              <div class="muted mini" style="margin-top:8px">${(r.perks||[]).slice(0,3).map(x=>`‚Ä¢ ${escapeHTML(x)}`).join("<br>")}</div>
            </div>
            <div>
              <input type="radio" name="racePick" value="${r.id}" ${sel?"checked":""}>
            </div>
          </div>
        `;
      }).join("")}
    </div>
  `;

  tab.querySelectorAll("input[name=racePick]").forEach(inp=>{
    inp.onchange = ()=>{
      const p2 = getPlayer(playerId);
      p2.character.preferredRaceId = inp.value;
      saveDB(DB); DB = loadDB();
      renderRaceTab(playerId);
    };
  });
}

function renderClassTab(playerId){
  const p = getPlayer(playerId);
  const tab = $("tabClasses");
  const picked = p.character.classId;

  tab.innerHTML = `
    <div class="row" style="justify-content:space-between">
      <div>
        <b>Escolha sua classe</b>
        <div class="muted mini">Classe d√° b√¥nus leves em atributos e fortes em per√≠cias.</div>
      </div>
      <span class="tag lore">Guerra do V√©u</span>
    </div>
    <div class="divider"></div>

    <div class="selectGrid">
      ${DB.classes.map(c=>{
        const sel = c.id===picked;
        return `
          <div class="selectCard ${sel ? "selectedGlow":""}">
            <div class="left">
              <div class="row" style="justify-content:space-between;gap:10px">
                <b>${escapeHTML(c.name)}</b>
                <span class="tag">classe</span>
              </div>
              <div class="muted mini" style="margin-top:6px">${escapeHTML(c.lore)}</div>
              <div class="muted mini" style="margin-top:8px">
                <b>Buffs:</b><br>${formatBuffs(c.buffs)}
              </div>
            </div>
            <div>
              <input type="radio" name="classPick" value="${c.id}" ${sel?"checked":""}>
            </div>
          </div>
        `;
      }).join("")}
    </div>
  `;

  tab.querySelectorAll("input[name=classPick]").forEach(inp=>{
    inp.onchange = ()=>{
      const p2 = getPlayer(playerId);
      p2.character.classId = inp.value;
      saveDB(DB); DB = loadDB();
      renderClassTab(playerId);
    };
  });
}

function renderAttrTab(playerId){
  const p = getPlayer(playerId);
  const tab = $("tabAttrs");

  const total = totalAttrPoints(p);
  const spent = spentAttrPoints(p);
  const left = total - spent;

  tab.innerHTML = `
    <div class="row" style="justify-content:space-between">
      <div>
        <b>Distribuir Atributos</b>
        <div class="muted mini">Voc√™ tem <b>${total}</b> pontos. Desvantagens aumentam esse total.</div>
      </div>
      <span class="pill">Restantes: <b>${left}</b></span>
    </div>
    <div class="divider"></div>

    <div style="display:grid;gap:12px">
      ${ATTR_KEYS.map(k=>{
        const v = Number(p.character.attrs[k]||0);
        const pct = clamp(v,0,10)*10;
        return `
          <div class="meterRow">
            <div>
              <div style="font-weight:950">${ATTR_LABEL[k]}</div>
              <div class="muted mini">Valor atual: <b>${v}</b></div>
            </div>
            <div class="bar"><div style="width:${pct}%"></div></div>
            <div class="ctrl">
              <button class="secondary" data-dec="${k}">-</button>
              <span class="num">${v}</span>
              <button class="secondary" data-inc="${k}">+</button>
            </div>
          </div>
        `;
      }).join("")}
    </div>
  `;

  tab.querySelectorAll("button[data-inc]").forEach(b=>{
    b.onclick = ()=>{
      const k = b.dataset.inc;
      const p2 = getPlayer(playerId);
      if(spentAttrPoints(p2) >= totalAttrPoints(p2)) return;
      p2.character.attrs[k] = Number(p2.character.attrs[k]||0)+1;
      saveDB(DB); DB = loadDB();
      renderAttrTab(playerId);
      renderCharacterCreator(getPlayer(playerId));
    };
  });
  tab.querySelectorAll("button[data-dec]").forEach(b=>{
    b.onclick = ()=>{
      const k = b.dataset.dec;
      const p2 = getPlayer(playerId);
      p2.character.attrs[k] = Math.max(0, Number(p2.character.attrs[k]||0)-1);
      saveDB(DB); DB = loadDB();
      renderAttrTab(playerId);
      renderCharacterCreator(getPlayer(playerId));
    };
  });
}

function renderSkillTab(playerId){
  const p = getPlayer(playerId);
  const tab = $("tabSkills");

  const total = totalSkillPicks(p);
  const spent = spentSkillPicks(p);
  const left = total - spent;

  tab.innerHTML = `
    <div class="row" style="justify-content:space-between">
      <div>
        <b>Distribuir Per√≠cias</b>
        <div class="muted mini">Cada sele√ß√£o adiciona <b>+4</b> em uma per√≠cia. Sem limite por per√≠cia, s√≥ no total.</div>
      </div>
      <span class="pill">Sele√ß√µes restantes: <b>${left}</b></span>
    </div>
    <div class="divider"></div>

    <div style="display:grid;gap:12px">
      ${SKILL_KEYS.map(k=>{
        const v = Number(p.character.skills[k]||0);
        const picksHere = Math.floor(v/4);
        const pct = clamp(picksHere,0,12)*8; // s√≥ visual
        return `
          <div class="meterRow">
            <div>
              <div style="font-weight:950">${SKILL_LABEL[k]}</div>
              <div class="muted mini">Valor: <b>${v}</b> (sele√ß√µes: ${picksHere})</div>
            </div>
            <div class="bar"><div style="width:${pct}%"></div></div>
            <div class="ctrl">
              <button class="secondary" data-sdec="${k}">-</button>
              <span class="num">${v}</span>
              <button class="secondary" data-sinc="${k}">+</button>
            </div>
          </div>
        `;
      }).join("")}
    </div>
  `;

  tab.querySelectorAll("button[data-sinc]").forEach(b=>{
    b.onclick = ()=>{
      const k = b.dataset.sinc;
      const p2 = getPlayer(playerId);
      if(spentSkillPicks(p2) >= totalSkillPicks(p2)) return;
      p2.character.skills[k] = Number(p2.character.skills[k]||0) + 4;
      saveDB(DB); DB = loadDB();
      renderSkillTab(playerId);
      renderCharacterCreator(getPlayer(playerId));
    };
  });
  tab.querySelectorAll("button[data-sdec]").forEach(b=>{
    b.onclick = ()=>{
      const k = b.dataset.sdec;
      const p2 = getPlayer(playerId);
      p2.character.skills[k] = Math.max(0, Number(p2.character.skills[k]||0) - 4);
      saveDB(DB); DB = loadDB();
      renderSkillTab(playerId);
      renderCharacterCreator(getPlayer(playerId));
    };
  });
}

function renderDisadvTab(playerId){
  const p = getPlayer(playerId);
  const tab = $("tabDisadv");
  const picked = new Set(p.character.disadvantages||[]);
  const b = disadvBonus(p);

  tab.innerHTML = `
    <div class="row" style="justify-content:space-between">
      <div>
        <b>Desvantagens</b>
        <div class="muted mini">Voc√™ ganha pontos extras, mas assume consequ√™ncias no roleplay.</div>
      </div>
      <span class="pill">B√¥nus: <b>+${b.attr}</b> atributos ‚Ä¢ <b>+${b.skillPicks}</b> sele√ß√µes de per√≠cia</span>
    </div>
    <div class="divider"></div>

    <div class="selectGrid">
      ${DB.disadvantages.map(d=>{
        const sel = picked.has(d.id);
        return `
          <label class="selectCard ${sel ? "selectedGlow":""}" style="cursor:pointer">
            <div class="left">
              <div class="row" style="justify-content:space-between;gap:10px">
                <b>${escapeHTML(d.name)}</b>
                <span class="tag">+${d.points.attr} attr ‚Ä¢ +${d.points.skillPicks} picks</span>
              </div>
              <div class="muted mini" style="margin-top:6px">${escapeHTML(d.desc)}</div>
            </div>
            <div>
              <input type="checkbox" data-dv="${d.id}" ${sel?"checked":""}>
            </div>
          </label>
        `;
      }).join("")}
    </div>
  `;

  tab.querySelectorAll("input[type=checkbox][data-dv]").forEach(chk=>{
    chk.onchange = ()=>{
      const id = chk.dataset.dv;
      const p2 = getPlayer(playerId);
      const set = new Set(p2.character.disadvantages||[]);
      if(chk.checked) set.add(id); else set.delete(id);
      p2.character.disadvantages = Array.from(set);
      saveDB(DB); DB = loadDB();
      renderDisadvTab(playerId);
      renderCharacterCreator(getPlayer(playerId));
    };
  });
}

/* =========================
   Confirm -> Wheel -> Finalize
========================= */
function openCreationSummary(playerId, willSpin){
  const p = getPlayer(playerId);
  const racePref = getRace(p.character.preferredRaceId);
  const cls = getClass(p.character.classId);

  const attrTotal = totalAttrPoints(p);
  const attrSpent = spentAttrPoints(p);
  const skillTotal = totalSkillPicks(p);
  const skillSpent = spentSkillPicks(p);

  const dvNames = (p.character.disadvantages||[]).map(id=>getDisadv(id)?.name).filter(Boolean);

  const html = `
    <div class="overlay" id="ovSum">
      <div class="modal">
        <div class="modalHeader">
          <div>
            <div style="font-size:16px;font-weight:950">Resumo da cria√ß√£o</div>
            <div class="muted mini">Confira tudo antes da roleta travar sua ra√ßa final.</div>
          </div>
          <button class="danger" id="closeSum">Voltar</button>
        </div>

        <div class="divider"></div>

        <div class="grid" style="grid-template-columns:1fr;gap:12px">
          <div class="card" style="background:#0c131c">
            <div class="row" style="justify-content:space-between">
              <b>Identidade</b>
              <span class="tag lore">Guerra do V√©u</span>
            </div>
            <div class="divider"></div>
            <div class="row" style="justify-content:space-between"><span>Nome</span><b>${escapeHTML(p.character.charName||p.username)}</b></div>
            <div class="row" style="justify-content:space-between"><span>Ra√ßa preferida</span><b>${escapeHTML(racePref?.name||"‚Äî")}</b></div>
            <div class="row" style="justify-content:space-between"><span>Classe</span><b>${escapeHTML(cls?.name||"‚Äî")}</b></div>
          </div>

          <div class="card" style="background:#0c131c">
            <b>Pontos</b>
            <div class="divider"></div>
            <div class="row" style="justify-content:space-between"><span>Atributos</span><b>${attrSpent}/${attrTotal}</b></div>
            <div class="row" style="justify-content:space-between"><span>Per√≠cias (sele√ß√µes)</span><b>${skillSpent}/${skillTotal}</b></div>
            <div class="row" style="justify-content:space-between"><span>Desvantagens</span><b>${dvNames.length ? escapeHTML(dvNames.join(", ")) : "‚Äî"}</b></div>
          </div>

          <div class="card" style="background:#0c131c">
            <b>Atributos</b>
            <div class="divider"></div>
            ${ATTR_KEYS.map(k=>`<div class="row" style="justify-content:space-between"><span>${ATTR_LABEL[k]}</span><b>${Number(p.character.attrs[k]||0)}</b></div>`).join("")}
          </div>

          <div class="card" style="background:#0c131c">
            <b>Per√≠cias</b>
            <div class="divider"></div>
            ${SKILL_KEYS.map(k=>`<div class="row" style="justify-content:space-between"><span>${SKILL_LABEL[k]}</span><b>${Number(p.character.skills[k]||0)}</b></div>`).join("")}
          </div>

          ${willSpin ? `
            <div class="warn">
              <b>Confirmar mesmo?</b>
              <div class="muted mini" style="margin-top:6px">
                Ao continuar, voc√™ gira a roleta e sua ra√ßa final ser√° travada. N√£o poder√° trocar depois.
              </div>
              <div class="row" style="justify-content:flex-end;margin-top:10px">
                <button class="secondary" id="cancelSpin">N√£o, voltar</button>
                <button id="goSpin">Sim, girar roleta</button>
              </div>
            </div>
          ` : `
            <div class="good">
              <b class="ok">Ok!</b>
              <div class="muted mini" style="margin-top:6px">Se quiser, volte e ajuste. Quando estiver pronto, clique em ‚ÄúConfirmar e girar roleta‚Äù.</div>
            </div>
          `}
        </div>
      </div>
    </div>
  `;

  const ov = document.createElement("div");
  ov.innerHTML = html;
  document.body.appendChild(ov.firstElementChild);

  $("closeSum").onclick = ()=>$("ovSum").remove();
  $("ovSum").addEventListener("click",(e)=>{ if(e.target.id==="ovSum") e.target.remove(); });

  if(willSpin){
    $("cancelSpin").onclick = ()=>$("ovSum").remove();
    $("goSpin").onclick = ()=>{
      $("ovSum").remove();
      openWheelModal(playerId);
    };
  }
}

function openWheelModal(playerId){
  const p = getPlayer(playerId);
  const preferred = p.character.preferredRaceId;

  const segments = buildWheelSegments(preferred);

  const html = `
    <div class="overlay" id="ovWheel">
      <div class="modal">
        <div class="modalHeader">
          <div>
            <div style="font-size:16px;font-weight:950">Roleta das Ra√ßas</div>
            <div class="muted mini">Clique em <b>Girar</b>. O resultado fica travado.</div>
          </div>
          <button class="danger" id="closeWheel">Fechar</button>
        </div>

        <div class="divider"></div>

        <div class="wheelWrap">
          <div class="pointer"></div>
          <canvas id="wheelCanvas" width="560" height="560"></canvas>

          <div class="row">
            <button id="btnSpin">Girar</button>
            <button class="secondary" id="btnBack">Voltar</button>
          </div>

          <div id="wheelResult" class="card hidden" style="background:#0c131c;max-width:900px;width:100%"></div>
        </div>
      </div>
    </div>
  `;
  const ov = document.createElement("div");
  ov.innerHTML = html;
  document.body.appendChild(ov.firstElementChild);

  $("closeWheel").onclick = ()=>$("ovWheel").remove();
  $("btnBack").onclick = ()=>{ $("ovWheel").remove(); render(); };

  const canvas = $("wheelCanvas");
  const ctx = canvas.getContext("2d");
  let rotation=0;
  let spinning=false;

  drawWheel(ctx, segments, rotation);

  $("btnSpin").onclick = async ()=>{
    if(spinning) return;
    spinning=true;

    const winner = weightedPick(segments);

    const baseStop = segmentAngleToStopOn(winner);
    const extraSpins = (Math.PI*2) * (6 + Math.floor(Math.random()*3));
    const startRotation = rotation;
    const finalRotation = baseStop + extraSpins;

    const duration = 2600 + Math.floor(Math.random()*500);
    const t0 = performance.now();

    function easeOutCubic(t){ return 1 - Math.pow(1-t,3); }

    await new Promise(resolve=>{
      function step(t){
        const p = clamp((t - t0)/duration, 0, 1);
        const e = easeOutCubic(p);
        rotation = startRotation + (finalRotation - startRotation) * e;
        drawWheel(ctx, segments, rotation);
        if(p<1) requestAnimationFrame(step);
        else resolve();
      }
      requestAnimationFrame(step);
    });

    // Finaliza: define ra√ßa final, aplica b√¥nus de ra√ßa + classe, trava, marca criado
    const player = getPlayer(playerId);
    const finalRace = winner.race;
    const cls = getClass(player.character.classId);

    player.character.finalRaceId = finalRace.id;

    applyBonusesToSheet(player, finalRace, cls);

    player.characterCreated = true;
    player.log.unshift({ts:Date.now(), text:`Cria√ß√£o conclu√≠da. Ra√ßa final: ${finalRace.name}.`});

    saveDB(DB); DB = loadDB();
    showWheelResult(playerId, finalRace);

    spinning=false;
  };
}

function showWheelResult(playerId, race){
  const p = getPlayer(playerId);
  const cls = getClass(p.character.classId);

  const result = $("wheelResult");
  result.classList.remove("hidden");

  const tag = race.tier==="perfeita"
    ? `<span class="tag perfect">PERFEITA</span>`
    : `<span class="tag">padr√£o</span>`;

  const d = calcDerived(p);

  result.innerHTML = `
    <div class="row" style="justify-content:space-between">
      <div>
        <div style="font-size:16px;font-weight:950">Resultado: ${escapeHTML(race.name)} ${tag}</div>
        ${race.tier==="perfeita" ? `<div class="tag perfect" style="margin-top:8px">Por essa ra√ßa exige uma troca</div>` : ``}
        <div class="muted mini" style="margin-top:8px">${escapeHTML(race.note||"")}</div>
      </div>
      <button id="finishNow" class="secondary">Ir para ficha</button>
    </div>

    <div class="divider"></div>

    <div class="grid" style="grid-template-columns:1fr;gap:12px">
      <div class="card" style="background:#0b121a">
        <b>Buffs da ra√ßa</b>
        <div class="divider"></div>
        <div class="muted mini">${formatBuffs(race.buffs)}<br><br>${(race.perks||[]).map(x=>`‚Ä¢ ${escapeHTML(x)}`).join("<br>")}</div>
      </div>

      <div class="card" style="background:#0b121a">
        <b>Classe escolhida</b>
        <div class="divider"></div>
        <div class="muted mini"><b>${escapeHTML(cls?.name||"‚Äî")}</b><br>${escapeHTML(cls?.lore||"")}<br><br>${formatBuffs(cls?.buffs)}</div>
      </div>

      <div class="card" style="background:#0b121a">
        <b>Barras (j√° calculadas)</b>
        <div class="divider"></div>
        <div class="row" style="gap:10px;flex-wrap:wrap">
          <span class="pill">Vida: <b>${d.vida}</b></span>
          <span class="pill">Defesa: <b>${d.defesa}</b></span>
          <span class="pill">Velocidade: <b>${d.velocidade}</b></span>
          <span class="pill">Foco do V√©u: <b>${d.foco}</b></span>
        </div>
      </div>
    </div>
  `;

  $("finishNow").onclick = ()=>{
    $("ovWheel").remove();
    render();
  };
}

function fileToDataUrl(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=>resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

/* =========================
   Global events
========================= */
$("btnLogin").onclick = ()=>{
  const u = $("loginUser").value.trim();
  const p = $("loginPass").value.trim();
  const res = login(u,p);
  if(!res.ok){ toast(res.msg, false); return; }
  DB = loadDB();
  render();
};
$("btnLogout").onclick = ()=>logout();

$("btnReset").onclick = ()=>{
  if(confirm("Isso vai apagar os dados do site nesse navegador. Tem certeza?")){
    localStorage.removeItem(KEY);
    DB = loadDB();
    render();
  }
};

/* =========================
   Render init
========================= */
function render(){
  const user = findUserBySession();

  $("btnLogout").classList.toggle("hidden", !user);
  $("loginCard").classList.toggle("hidden", !!user);
  $("appRoot").classList.toggle("hidden", !user);

  $("sessionPill").textContent = user
    ? `Sess√£o: ${user.role==="master" ? "Mestre" : "Player"} (${user.username})`
    : "Sess√£o: n√£o logado";

  if(!user) return;

  if(user.role==="master") renderMaster();
  else renderPlayer(user.playerId);
}

render();
</script>
</body>
</html>
