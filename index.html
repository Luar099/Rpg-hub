<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Voltar dos Mortos — MiniGame (WASD)</title>
  <style>
    :root{
      --bg:#05060a;
      --panel:#0f1220;
      --line:rgba(255,255,255,.12);
      --txt:#f2f4ff;
      --muted:#a7adc2;
      --good:#22c55e;
      --ok:#eab308;
      --bad:#ef4444;
      --ghost:#8b5cf6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1000px 600px at 50% 20%, rgba(139,92,246,.18), transparent 60%),
                  radial-gradient(900px 700px at 20% 80%, rgba(34,197,94,.10), transparent 60%),
                  var(--bg);
      color:var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .wrap{
      width:min(980px, 100%);
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:16px;
    }
    @media (max-width: 880px){
      .wrap{grid-template-columns:1fr}
    }
    .card{
      background: rgba(15,18,32,.9);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: 0 18px 45px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .topbar{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), transparent);
    }
    .title{
      display:flex; flex-direction:column; gap:2px;
    }
    .title b{font-size:15px; letter-spacing:.2px}
    .title span{font-size:12px; color:var(--muted)}
    .hud{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
      font-size:12px;
    }
    .pill{
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(255,255,255,.03);
      color:var(--txt);
      white-space:nowrap;
    }
    .pill strong{font-weight:700}
    .btn{
      cursor:pointer;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--txt);
      padding:8px 10px;
      border-radius:12px;
      font-weight:600;
    }
    .btn:hover{background: rgba(255,255,255,.10)}
    canvas{
      width:100%;
      height:640px;
      display:block;
      background:
        linear-gradient(180deg, rgba(255,255,255,.04), transparent 40%),
        radial-gradient(800px 500px at 50% 20%, rgba(139,92,246,.12), transparent 60%),
        #070815;
    }
    .side{
      padding:14px 16px;
    }
    .side h3{
      margin:0 0 8px 0;
      font-size:14px;
      letter-spacing:.2px;
    }
    .side p{
      margin:0 0 10px 0;
      color:var(--muted);
      font-size:12.5px;
      line-height:1.35;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin:10px 0 12px 0;
    }
    .k{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background: rgba(255,255,255,.03);
    }
    .k .key{
      font-weight:900;
      font-size:16px;
      letter-spacing:.6px;
    }
    .k .desc{
      font-size:12px;
      color:var(--muted);
      margin-top:3px;
    }
    .legend{
      border-top:1px dashed var(--line);
      padding-top:12px;
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:12.5px;
      color:var(--muted);
    }
    .dot{
      display:inline-block;
      width:10px; height:10px;
      border-radius:50%;
      margin-right:8px;
      vertical-align:middle;
    }
    .overlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      padding:18px;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(720px, 100%);
      background: rgba(12,14,25,.95);
      border:1px solid var(--line);
      border-radius:20px;
      padding:18px;
      box-shadow: 0 22px 70px rgba(0,0,0,.6);
    }
    .modal h2{margin:0 0 8px 0; font-size:18px}
    .modal p{margin:0 0 12px 0; color:var(--muted); line-height:1.4}
    .modal .row{display:flex; gap:10px; flex-wrap:wrap}
    .small{
      font-size:12px; color:var(--muted);
      margin-top:10px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <div class="title">
          <b>VOLTA DOS MORTOS</b>
          <span>Minigame de renascimento (W A S D) — meta: <strong>6700</strong> pontos</span>
        </div>
        <div class="hud">
          <span class="pill">Pontos: <strong id="score">0</strong></span>
          <span class="pill">Combo: <strong id="combo">0</strong></span>
          <span class="pill">Vida da alma: <strong id="soul">100</strong>%</span>
          <button class="btn" id="btnStart">Iniciar</button>
          <button class="btn" id="btnPause">Pausar</button>
          <button class="btn" id="btnReset">Reset</button>
        </div>
      </div>
      <canvas id="game" width="900" height="640"></canvas>
    </div>

    <div class="card side">
      <h3>Como funciona</h3>
      <p>
        Notas descem em 4 trilhas. Aperte a tecla certa quando a nota encostar na linha de acerto.
        Quanto mais combo, mais você acelera a “volta à vida”.
      </p>

      <div class="grid">
        <div class="k"><div class="key">W</div><div class="desc">Trilha 1</div></div>
        <div class="k"><div class="key">A</div><div class="desc">Trilha 2</div></div>
        <div class="k"><div class="key">S</div><div class="desc">Trilha 3</div></div>
        <div class="k"><div class="key">D</div><div class="desc">Trilha 4</div></div>
      </div>

      <p>
        <strong>Dicas pro RPG:</strong> você pode narrar como se cada acerto fosse “lembrar um motivo pra viver”.
        Se falhar muito, a “vida da alma” cai e você precisa tentar de novo.
      </p>

      <div class="legend">
        <div><span class="dot" style="background:var(--good)"></span>Perfeito: +200</div>
        <div><span class="dot" style="background:var(--ok)"></span>Bom: +100</div>
        <div><span class="dot" style="background:var(--bad)"></span>Erro: -5% alma</div>
        <div><span class="dot" style="background:var(--ghost)"></span>Meta: 6700 = Renasce</div>
      </div>

      <div class="small">
        Controles extras: <strong>Espaço</strong> (pausa), <strong>R</strong> (reset).
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <h2 id="modalTitle">Voltar dos Mortos</h2>
      <p id="modalText">Aperte Iniciar e siga o ritmo.</p>
      <div class="row">
        <button class="btn" id="modalPlay">Jogar</button>
        <button class="btn" id="modalReset">Reset</button>
        <button class="btn" id="modalClose">Fechar</button>
      </div>
      <div class="small" id="modalHint"></div>
    </div>
  </div>

<script>
(() => {
  // ======== CONFIG ========
  const TARGET_SCORE = 6700;

  // trilhas: 0=W, 1=A, 2=S, 3=D
  const LANES = [
    { key:"W", code:"KeyW" },
    { key:"A", code:"KeyA" },
    { key:"S", code:"KeyS" },
    { key:"D", code:"KeyD" },
  ];

  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d", { alpha: false });

  // UI
  const $score = document.getElementById("score");
  const $combo = document.getElementById("combo");
  const $soul  = document.getElementById("soul");

  const btnStart = document.getElementById("btnStart");
  const btnPause = document.getElementById("btnPause");
  const btnReset = document.getElementById("btnReset");

  const overlay = document.getElementById("overlay");
  const modalTitle = document.getElementById("modalTitle");
  const modalText = document.getElementById("modalText");
  const modalHint = document.getElementById("modalHint");
  const modalPlay = document.getElementById("modalPlay");
  const modalReset = document.getElementById("modalReset");
  const modalClose = document.getElementById("modalClose");

  // ======== GAME STATE ========
  let running = false;
  let paused = false;
  let lastT = 0;

  let score = 0;
  let combo = 0;
  let soul = 100; // 0..100

  // spawn control
  let spawnTimer = 0;
  let spawnEvery = 520; // ms base

  // notes
  const notes = [];
  let noteId = 1;

  // feedback
  const flashes = [0,0,0,0]; // lane flash intensity
  let message = ""; // small HUD message
  let messageTimer = 0;

  // timing
  const hitY = canvas.height - 110;
  const hitWindowPerfect = 18; // px
  const hitWindowGood = 34;    // px

  // visuals
  const laneW = canvas.width / 4;
  const lanePadding = 14;
  const noteRadius = 22;

  function resetGame() {
    score = 0;
    combo = 0;
    soul = 100;
    notes.length = 0;
    noteId = 1;
    spawnTimer = 0;
    spawnEvery = 520;
    message = "";
    messageTimer = 0;
    flashes.fill(0);
    updateHUD();
  }

  function updateHUD(){
    $score.textContent = Math.floor(score);
    $combo.textContent = combo;
    $soul.textContent = Math.max(0, Math.min(100, Math.floor(soul)));
  }

  function showOverlay(title, text, hint=""){
    modalTitle.textContent = title;
    modalText.textContent = text;
    modalHint.textContent = hint;
    overlay.classList.add("show");
  }
  function hideOverlay(){
    overlay.classList.remove("show");
  }

  function startGame(){
    if (!running){
      running = true;
      paused = false;
      lastT = performance.now();
      requestAnimationFrame(loop);
    } else {
      paused = false;
    }
  }

  function togglePause(){
    if (!running) return;
    paused = !paused;
    if (!paused){
      lastT = performance.now();
      requestAnimationFrame(loop);
    }
  }

  function endWin(){
    paused = true;
    running = true; // ainda está "no jogo", só travado
    showOverlay(
      "RENASCIMENTO!",
      `Você alcançou ${TARGET_SCORE} pontos. A alma encontra o caminho de volta…`,
      "No RPG: o personagem renasce (você decide o custo, marca, cicatriz ou consequência)."
    );
  }

  function endLose(){
    paused = true;
    running = true;
    showOverlay(
      "A ALMA DESFIA...",
      "Você falhou muitas vezes. A conexão com o corpo se rompeu por enquanto.",
      "No RPG: tente de novo após descanso, ritual, ajuda de um aliado, ou pagando um preço."
    );
  }

  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

  function spawnNote(){
    // peso: às vezes vem "dupla" para aumentar tensão
    const lane = Math.floor(Math.random() * 4);
    notes.push({
      id: noteId++,
      lane,
      y: -40,
      speed: 260 + (Math.min(combo, 30) * 3), // acelera com combo
      hit: false
    });

    // chance de uma segunda nota
    if (Math.random() < 0.18){
      const lane2 = (lane + 1 + Math.floor(Math.random()*3)) % 4;
      notes.push({
        id: noteId++,
        lane: lane2,
        y: -80,
        speed: 250 + (Math.min(combo, 30) * 3),
        hit: false
      });
    }
  }

  function gradeHit(note){
    const dy = Math.abs(note.y - hitY);
    if (dy <= hitWindowPerfect) return "perfect";
    if (dy <= hitWindowGood) return "good";
    return "miss";
  }

  function onKeyLane(laneIndex){
    if (!running) return;
    if (paused) return;

    // nota mais próxima da linha nessa lane
    let best = null;
    let bestDy = Infinity;

    for (const n of notes){
      if (n.hit) continue;
      if (n.lane !== laneIndex) continue;
      const dy = Math.abs(n.y - hitY);
      if (dy < bestDy){
        bestDy = dy;
        best = n;
      }
    }

    flashes[laneIndex] = 1.0;

    if (!best){
      // nada para acertar: pequeno castigo
      combo = 0;
      soul = clamp(soul - 2, 0, 100);
      message = "Vazio…";
      messageTimer = 380;
      updateHUD();
      if (soul <= 0) endLose();
      return;
    }

    const g = gradeHit(best);
    if (g === "perfect"){
      best.hit = true;
      combo += 1;
      score += 200 + Math.min(combo, 30) * 3;
      soul = clamp(soul + 0.6, 0, 100);
      message = "PERFEITO!";
      messageTimer = 420;
    } else if (g === "good"){
      best.hit = true;
      combo += 1;
      score += 100 + Math.min(combo, 25) * 2;
      soul = clamp(soul + 0.3, 0, 100);
      message = "Bom!";
      messageTimer = 360;
    } else {
      // apertou fora do tempo
      combo = 0;
      soul = clamp(soul - 5, 0, 100);
      message = "ERRO!";
      messageTimer = 420;
    }

    updateHUD();
    if (score >= TARGET_SCORE) endWin();
    if (soul <= 0) endLose();
  }

  function drawBackground(){
    // fundo
    ctx.fillStyle = "#070815";
    ctx.fillRect(0,0,canvas.width, canvas.height);

    // trilhas
    for (let i=0;i<4;i++){
      const x = i * laneW;
      const flash = flashes[i];

      // lane panel
      ctx.fillStyle = "rgba(255,255,255,0.03)";
      ctx.fillRect(x, 0, laneW, canvas.height);

      // linhas laterais
      ctx.fillStyle = "rgba(255,255,255,0.10)";
      ctx.fillRect(x, 0, 1, canvas.height);

      // glow flash quando tecla pressiona
      if (flash > 0.001){
        ctx.fillStyle = `rgba(139,92,246,${0.22*flash})`;
        ctx.fillRect(x, 0, laneW, canvas.height);
      }
    }

    // linha de acerto
    ctx.fillStyle = "rgba(255,255,255,0.14)";
    ctx.fillRect(0, hitY, canvas.width, 2);

    // zona de acerto (visual)
    ctx.fillStyle = "rgba(255,255,255,0.04)";
    ctx.fillRect(0, hitY - hitWindowGood, canvas.width, hitWindowGood*2);

    // teclas no rodapé
    for (let i=0;i<4;i++){
      const cx = i*laneW + laneW/2;
      const cy = canvas.height - 55;

      ctx.beginPath();
      ctx.arc(cx, cy, 28, 0, Math.PI*2);
      ctx.fillStyle = "rgba(255,255,255,0.06)";
      ctx.fill();
      ctx.lineWidth = 2;
      ctx.strokeStyle = "rgba(255,255,255,0.12)";
      ctx.stroke();

      ctx.fillStyle = "#f2f4ff";
      ctx.font = "900 18px system-ui";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(LANES[i].key, cx, cy+1);
    }

    // barra de progresso para 6700
    const pad = 18;
    const barW = canvas.width - pad*2;
    const barH = 12;
    const bx = pad;
    const by = 18;

    ctx.fillStyle = "rgba(255,255,255,0.08)";
    ctx.fillRect(bx, by, barW, barH);

    const p = clamp(score / TARGET_SCORE, 0, 1);
    ctx.fillStyle = "rgba(139,92,246,0.55)";
    ctx.fillRect(bx, by, barW*p, barH);

    ctx.strokeStyle = "rgba(255,255,255,0.12)";
    ctx.strokeRect(bx, by, barW, barH);

    ctx.fillStyle = "rgba(255,255,255,0.8)";
    ctx.font = "600 12px system-ui";
    ctx.textAlign = "left";
    ctx.textBaseline = "bottom";
    ctx.fillText("Caminho do Renascimento", bx, by-3);

    // mensagem central
    if (messageTimer > 0 && message){
      ctx.font = "900 26px system-ui";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      const alpha = clamp(messageTimer/420, 0, 1);
      ctx.fillStyle = `rgba(242,244,255,${alpha})`;
      ctx.fillText(message, canvas.width/2, 90);
    }

    // status pausa
    if (!running){
      ctx.font = "900 34px system-ui";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillStyle = "rgba(242,244,255,0.9)";
      ctx.fillText("APERTE INICIAR", canvas.width/2, canvas.height/2 - 20);
      ctx.font = "600 14px system-ui";
      ctx.fillStyle = "rgba(167,173,194,0.9)";
      ctx.fillText("W A S D para acertar as notas. Espaço para pausar.", canvas.width/2, canvas.height/2 + 22);
    } else if (paused){
      ctx.font = "900 34px system-ui";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillStyle = "rgba(242,244,255,0.9)";
      ctx.fillText("PAUSADO", canvas.width/2, canvas.height/2 - 10);
      ctx.font = "600 14px system-ui";
      ctx.fillStyle = "rgba(167,173,194,0.9)";
      ctx.fillText("Aperte Espaço para voltar.", canvas.width/2, canvas.height/2 + 26);
    }
  }

  function drawNotes(){
    for (const n of notes){
      if (n.hit) continue;
      const cx = n.lane * laneW + laneW/2;
      const y = n.y;

      // corpo da nota
      const glow = 0.22 + Math.min(combo, 30)*0.004;
      ctx.beginPath();
      ctx.arc(cx, y, noteRadius, 0, Math.PI*2);
      ctx.fillStyle = `rgba(139,92,246,${glow})`;
      ctx.fill();

      ctx.lineWidth = 3;
      ctx.strokeStyle = "rgba(255,255,255,0.25)";
      ctx.stroke();

      // símbolo
      ctx.fillStyle = "rgba(242,244,255,0.95)";
      ctx.font = "900 16px system-ui";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(LANES[n.lane].key, cx, y+1);
    }
  }

  function update(dt){
    // anima flash
    for (let i=0;i<4;i++){
      flashes[i] = Math.max(0, flashes[i] - dt*2.8);
    }

    // mensagens
    if (messageTimer > 0){
      messageTimer -= dt*1000;
      if (messageTimer <= 0){
        messageTimer = 0;
        message = "";
      }
    }

    // spawn: quanto maior o combo, mais rápido gera notas
    const comboBoost = Math.min(combo, 40);
    const dynamicEvery = clamp(spawnEvery - comboBoost*6, 250, 520);

    spawnTimer += dt*1000;
    while (spawnTimer >= dynamicEvery){
      spawnTimer -= dynamicEvery;
      spawnNote();
    }

    // mover notas
    for (const n of notes){
      if (n.hit) continue;
      n.y += n.speed * dt;
    }

    // notas que passaram
    for (const n of notes){
      if (n.hit) continue;
      if (n.y > hitY + hitWindowGood + 55){
        // perdeu
        n.hit = true; // remove
        combo = 0;
        soul = clamp(soul - 5, 0, 100);
        message = "PERDEU!";
        messageTimer = 360;
        updateHUD();
        if (soul <= 0) { endLose(); break; }
      }
    }

    // limpar notas já marcadas
    // (mantém array leve)
    for (let i=notes.length-1;i>=0;i--){
      if (notes[i].hit) notes.splice(i,1);
    }
  }

  function loop(t){
    if (!running) return;

    const dt = (t - lastT) / 1000;
    lastT = t;

    if (!paused){
      update(dt);
    }

    drawBackground();
    drawNotes();

    requestAnimationFrame(loop);
  }

  // ======== INPUT ========
  window.addEventListener("keydown", (e) => {
    if (e.repeat) return;

    if (e.code === "Space"){
      e.preventDefault();
      if (!running){
        startGame();
      } else {
        togglePause();
      }
      return;
    }

    if (e.code === "KeyR"){
      resetGame();
      running = false;
      paused = false;
      drawBackground();
      drawNotes();
      return;
    }

    const idx = LANES.findIndex(l => l.code === e.code);
    if (idx !== -1){
      e.preventDefault();
      onKeyLane(idx);
    }
  });

  // ======== BUTTONS ========
  btnStart.addEventListener("click", () => {
    hideOverlay();
    if (!running){
      resetGame();
      startGame();
    } else {
      paused = false;
    }
  });

  btnPause.addEventListener("click", () => {
    togglePause();
  });

  btnReset.addEventListener("click", () => {
    hideOverlay();
    resetGame();
    running = false;
    paused = false;
    drawBackground();
    drawNotes();
  });

  modalPlay.addEventListener("click", () => {
    hideOverlay();
    if (!running){
      resetGame();
      startGame();
    } else {
      paused = false;
      lastT = performance.now();
      requestAnimationFrame(loop);
    }
  });

  modalReset.addEventListener("click", () => {
    hideOverlay();
    resetGame();
    running = false;
    paused = false;
    drawBackground();
    drawNotes();
  });

  modalClose.addEventListener("click", () => hideOverlay());
  overlay.addEventListener("click", (e) => { if (e.target === overlay) hideOverlay(); });

  // ======== INIT ========
  resetGame();
  drawBackground();
  drawNotes();

  // tela inicial explicando
  showOverlay(
    "Voltar dos Mortos",
    "Aperte as teclas W A S D no tempo certo. Chegou em 6700 pontos? Você renasce.",
    "Dica: se quiser deixar mais difícil, eu posso colocar “ritmo fixo” tipo música e notas predefinidas."
  );
})();
</script>
</body>
</html>
